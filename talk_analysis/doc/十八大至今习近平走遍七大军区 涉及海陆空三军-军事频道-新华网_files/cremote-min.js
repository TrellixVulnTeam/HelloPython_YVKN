KISSY.add("xh/comment/1.0/cremote",function(a,b,c,d,e,f,g,h,i){var q,k={},l=d.all,m=d.one,n=a.Event;return a.DOM,a.UA.ie<7,q=window.xhnc_commentLanguage||{},b.extend(k,{options:{className:{sayRowCurrent:"sa-selected",sayWatched:"ss-watched"},tags:{userStatus:"user-status",userNick:"user-nick",userLayerNick:".dst-nick > a",userLayerStatus:".dst-status",login:"user-login",layerLogin:".dst-login",logout:"user-logout",layerLogout:".dst-logout",loginBtn:"login",logoutBtn:"logout",quickSend:"#quick",ctrl:"#dc-ctrl",list:"dc-list",pub:"dc-pub",text:"text",tip:"input_tip",submit:"submit",title:"#detail-title",news:"#detail-news",amount:".detail-amount",latestList:"dl-section",layerReplyCtrl:".ds-ctrl > .reply",layerTalk:".ds-talk",layerReply:".ds-reply",layerReplyInner:".dsr-reply",watch:".ds-watch > a",reportLinks:".ds-ctrl > .report",copyLinks:".ds-ctrl > .copy",icons:".ds-pic > a > img",dingLinks:".ds-ctrl > .ding",moreLinks:".dl-section > .more > .submit",layerMore:".ds-reply > .much > a",page:"#dc-page-list",pageLinks:"#dc-page-list > li > a",top:"#top",article:"#detail-article",container:"#da-comment",userIcon:".dep-entity",userIconList:".dst-entity",loginOther:".login-other",qq:".login-other > .qq"},baseId:""},last:{reply:{node:!1,show:!1}},remote:!1,parent:!1,callback:function(){},more:e.data.more,redirectUrl:window.location.href,init:function(a,c){b.extend(this.options,a,!0),this.remote=c.remote,this.parent=c.parent,this.callback="function"==typeof c.callback?c.callback:this.callback;var d=parseInt(this.remote.params.more);this.more=isNaN(d)?this.more:d,this.more=this.more<=0?-1:this.more,e.connectionInit(),e.connectionQQWeiboSet({config:{samewindow:!0}}),this.loadNews(),this.installUser()},installUser:function(){var a=this.options.tags,b=this;l(a.quickSend).on("click",function(){var b=l(a.ctrl).outerHeight(!0)+l(a.list).outerHeight(!0)+l(a.pub).outerHeight(!0);m(window).animate({scrollTop:b+"px"},{duration:.8,complete:function(){l(a.submit).fire("click")}})}),i.placeHolder(a.text,{text:q.placeholder}),l(a.text).on("keyup",function(c){return i.ctrl(c,13)?(b.doReply(a.text,a.tip),void 0):void 0}),l(a.submit).on("click",function(){b.doReply(a.text,a.tip)}),l(a.loginBtn).on("click",function(){b.showLogin()}),l(a.logoutBtn).on("click",function(){b.showLogout()})},loadUser:function(){var a=this;e.queryUserStatus(function(b){e.setUser(b.content),a.resetUser()},function(){e.setUser(null),a.resetUser()})},resetUser:function(){var a="#"+this.options.baseId,b=e.getUser(),c=this.options.tags,d=l(a+c.userStatus),g=l(a+c.login),h=l(a+c.logout),i=l(a+c.submit),j=l(a+c.userNick),k=l(c.userLayerNick),m=l(c.userLayerStatus),n=l(c.layerLogin),o=l(c.layerLogout),p=l(c.userIcon),r=l(c.userIconList),s=l(c.loginOther);b.userid?(this.callback(200,b),p.html('<img src="'+e.urls.userIcon+b.username+'"/>'),r.html('<img src="'+e.urls.userIcon+b.username+'"/>'),k.html(b.nickname),j.attr("href",b.zone),j.html(b.nickname),d.css("visibility","hidden"),h.show(),g.hide(),m.css("visibility","hidden"),n.hide(),o.show(),k.attr("href",b.zone),s.hide(),i.val(q.submit)):(this.callback(201,b),p.html(""),r.html(""),k.html(""),j.attr("href","javascript:;"),j.html(""),d.css("visibility","visible"),h.hide(),g.show(),m.css("visibility","visible"),n.show(),o.hide(),k.attr("href","javascript:;"),s.show(),i.val(q.submitFast)),f.lockReportUser(b),this.renderQuickReg()},loadNews:function(){var b,c,d;this.options.baseId,b=this,c=this.options.tags,d={newsId:e.queryNewsId(this.remote)},e.queryNews(d,function(a){l(c.amount).html(a.commAmount),e.setNews(a),a.code=200,b.callback(300,a),0!=a.commentFlag&&b.buildFrame()},function(a,c){a.info=c,b.callback(301,a),e.setNews(null)})},buildFrame:function(){var h,j,k,a=this,d=e.getNews();this.options,h=this.options.baseId,j=f.buildRemoteFrame(h),k=document.createDocumentFragment(),k.appendChild(j.dom),b.async({timer:50,fn:function(){l(a.parent).append(k),i.placeHolder("#"+h+"text",{text:q.placeholder});var b=".js-"+h+"-share";checkbox=new c,checkbox.init({selector:b}),l("#"+h+"rurl").val(a.redirectUrl),l("#"+h+"newsId").val(d.newsId),l("#"+h+"text").on("keyup",function(c){i.ctrl(c,13)&&a.doReply("#"+h+"text","#"+h+"input_tip",b,h)}),l("#"+h+"login").on("click",function(){a.showLogin()}),l("#"+h+"logout").on("click",function(){a.showLogout()}),l("#"+h+"submit").on("click",function(){a.doReply("#"+h+"text","#"+h+"input_tip",b,h)}),2!=d.commentFlag&&a.installFloat(),a.loadPurview(),a.resizeFrame(),a.installQQ()}})},installFloat:function(){var a=this.options.tags,b=this.options.baseId,c="#"+b+"dc-pub",d=c+"-placeholder",f=l(c).height();l(d).height(f),l(d).hide(),l(window).on("scroll",function(){var k,b=l(window).scrollTop(),e=l(a.container).offset().top,g=l(a.container).height(),h=e+g,i=l(c).offset().top,j=f+i;b>=i?(l(d).show(),l(c).width(l(c).width()),k=l(c).css("position"),Math.ceil(j)>=h?"absolute"!=k&&(l(c).css("position","absolute"),l(c).offset({top:h-f})):e>i&&"static"!=k?(l(c).css("position","static"),l(d).hide()):i>=e&&"fixed"!=k&&(l(c).css("position","fixed"),l(c).css("top","0px"),l(d).show())):(l(d).hide(),l(c).css("position","static"))})},resizeFrame:function(){var a=this.options.baseId,b=l(".do-editor").outerWidth(!0),c=l(".do-editor > .de-pic").outerWidth(!0);l(".do-editor > .de-input").width(b-c-30),l("#"+a+"text").width(b-c-42)},loadPurview:function(){var a=e.getNews(),b="#"+this.options.baseId,c=this.options.tags;1==a.commentFlag?l(b+c.list).hide():2==a.commentFlag?(l(b+c.pub).hide(),this.loadComment()):3==a.commentFlag&&this.loadComment(),l(b).all(".detail-amount b").html(a.commAmount),0==a.commAmount&&l(b+c.list).hide(),"zh"==q.language&&l(b).all(".detail-amount").attr({href:e.urls.detail+a.newsId+".html",target:"_blank"}),this.loadUser()},loadComment:function(){var a=this,c="#"+this.options.baseId,d=this.options.tags,g=e.getNews();e.queryCommentSingle({newsId:g.newsId},function(e){var h=c+d.latestList,i=f.buildRemoteComment(e.contentAll,g.commentFlag,a.more),j=e.contentAll?e.contentAll.length:0;j=void 0==j?0:j,l(h).removeClass("no-comment"),l(h).html(""),a.callback(400,{code:200,dynamicAmount:e.contentAll.length}),b.async({id:h,reload:!0,timer:50,fn:function(){l(h).html(i),0>=j&&(l(h).addClass("no-comment"),l(h+" > .more").hide()),a.resizeComment(),a.installReply(),a.installQQ(),a.installWatch(),a.installReport(),a.installCopy(),a.installDing(),a.installMore(),f.buildLazyImage(d.icons)}})},function(b,e){b.info=e,a.callback(401,b),l(c+d.latestList).html(e)})},resizeComment:function(){l(".dl-section > dl").each(function(){var a=l(this).outerWidth(!0),b=a-l(this).children("dt").outerWidth(!0);l(this).children("dd").width(b-18)})},installReply:function(){var a=this,b=this.options.tags;l(b.layerReplyCtrl).on("click",function(){var f,g,h,i,j,d=this.parentNode.parentNode,e=this.getAttribute("data-id");for(d.setAttribute("data-id",e),f=d.childNodes,g=a.last.reply,h="block",g.node===this?(h=g.show?"none":"block",g.show=!g.show):g.node!==this&&(g.show=!0),g.node=this,l(b.layerTalk).hide(),i=f.length-1;i>=0;i--)if(j=f[i],-1!=j.className.indexOf("ds-talk"))return j.style.display=h,n.fire("#"+j.id+"text","focus"),l("#"+j.id+"input_tip").html(""),void 0;a.showReply(d)})},installWatch:function(){var a=this,b=this.options.tags,c=this.options.className;l(b.watch).on("click",function(){var d,f,b=e.getUser();return"undefined"==typeof b.userid?(alert(q.loginNo),a.showLogin(),void 0):(d=this.getAttribute("data-watch"))?(f=this,d==b.userid?(alert(q.followSelfErr),void 0):(e.submitWatch({method:"add",operUserId:b.userid,targetUserId:d},function(a){var b=parseInt(a.code);switch(b){case 200:l(f).addClass(c.sayWatched),l(f).html(q.followPicked),n.detach(f,"click");break;case 500:alert(e.tip.err500);break;default:alert(q.followErr)}},function(a,b){alert(b)}),void 0)):(alert(q.parameErr),void 0)})},installReport:function(){var a=this.options.tags,b=this;l(a.reportLinks).on("click",function(){var a=this.getAttribute("data-cid"),c=this.getAttribute("data-uid"),d=this.getAttribute("data-uname");b.showReport({cid:a,uid:c,uname:d,content:l("#COM_"+a+"_content").html()})})},installCopy:function(){var a=this.options.tags;l(a.copyLinks).on("click",function(){var b=i.copy(window.location.href);return b?(alert(q.copySuccess),void 0):(window.prompt(q.copyText,window.location.href),void 0)})},installDing:function(){var a=this.options.tags;l(a.dingLinks).on("click",function(){var d,f,g,b=this.getAttribute("data-cid");this.getAttribute("data-uid"),d=this.getAttribute("data-status"),d||(e.submitDing({commentId:b,newsId:e.getNews().newsId}),f=l(this).all("em"),g=f.text(),f.html(parseInt(g)+1)),this.setAttribute("data-status",!0)})},installMore:function(){var a=this.options.tags,b=this,c=this.options.baseId,d=e.getNews();"zh"==q.language&&l(a.moreLinks).attr({href:e.urls.detail+d.newsId+".html",target:"_blank"}),l(a.moreLinks).on("click",function(){var a=this.getAttribute("data-time"),d=this.getAttribute("data-cur");return d>=a?!0:(d++,"zh"!=q.language&&d>=a&&l(this).hide(),this.setAttribute("data-cur",d),l("#"+c+"dl-section > .t-"+d).show(),b.resizeComment(),!1)})},installQQ:function(a){var c=this.options.tags;a=a?a:c.qq,l(a).detach("click"),l(a).on("click",function(){e.connectionQQWeibo(function(a){201==a.code&&f.buildRegister(a.name,function(a){return a})},function(a,b){200==b&&alert(a)},function(){})})},showReply:function(a){var k,d=this,g=e.getUser(),h=e.getNews(),j=f.buildReplyRemote(a,g);l(a).append(j.html),k=j.id,g.userid?(l("#"+k+"user-nick").attr("href",g.zone),l("#"+k+"user-icon").html('<img src="'+e.urls.userIcon+g.username+'"/>'),l("#"+k+"login-other").hide()):(l("#"+k+"user-nick").attr("href","javascript:;"),l("#"+k+"user-icon").html(""),l("#"+k+"login-other").show()),b.async({timer:100,fn:function(){var a,b,e;d.installQQ("#"+k+"login-other > .qq"),i.placeHolder("#"+k+"text",{text:q.placeholder}),a=".js-"+k+"-share",b=new c,b.init({selector:a}),e=l("#"+k+"text"),l("#"+k+"rurl").val(d.redirectUrl),l("#"+k+"newsId").val(h.newsId),l("#"+k+"parentId").val(e.attr("data-id")),e.fire("focus"),e.on("keyup",function(b){i.ctrl(b,13)&&d.doReply("#"+k+"text","#"+k+"input_tip",a,k)}),l("#"+k+"login").on("click",function(){d.showLogin()}),l("#"+k+"logout").on("click",function(){d.showLogout()}),l("#"+k+"submit").on("click",function(){d.doReply("#"+k+"text","#"+k+"input_tip",a,k)})}})},showLogin:function(){var a=this;f.buildLogin(function(a){e.setUser(a)},function(a,b){alert(b),e.setUser(null)},function(){a.resetUser()},function(a,b){b&&201==b.code&&f.buildRegister(b.nick,function(a){return a})})},showLogout:function(){var a=this;e.submitLogout(function(){e.setUser(null),a.resetUser()},function(){e.setUser(null),a.resetUser()})},showReport:function(a){var b=this,c=e.getUser();f.buildReport(c,a,function(){alert(q.reportSuccess)},function(a,c,d){alert(c),-200==d&&b.showLogin()},function(){})},doReply:function(a,b,c,d){var i,j,k,m,g=this,h=e.checkReply(a,b,1e3,function(){g.showLogin()});h&&(i=e.getNews(),j=l(a).attr("data-id"),k=l(c+":checked").val(),m=l("#"+d+"type").val(),1==m?(alert(q.replySuccess),l("#"+d+"form").fire("submit")):e.submitReply({newsId:i.newsId,content:h,parentId:j,shareToWb:k},function(b){b.content.userid?f.buildQuickRegister(b.content,function(){}):alert(q.commentSuccess),g.loadUser(),l(a).val("")},function(a,b){alert(b),g.loadUser()}))},renderQuickReg:function(){KISSY.use("xh/comment/1.0/cquick",function(a,b){new b})}}),k},{requires:["xh/common/1.0/lang","xh/common/1.0/checkbox","node","../1.0/cdata","../1.0/cbuilder","../1.0/cdialog","anim","xh/common/1.0/text","xh/common/1.0/url"]});